<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="./_style/images/logo.png" />
    <link rel="stylesheet" media="screen" href="./_style/app.screen.css">
    <link rel="stylesheet" media="screen" href="./_style/queries.screen.css">
    <title>Query Submissions</title>
  </head>
  <body>
    <header>
      <h1>Query Submissions</h1>
      <img src="./_style/images/logo.png" alt="SATCAP logo" />
    </header>
    <main>
      <button type="button" class="primary" id="newQuery">Create new</button>
      <p>Click the Create New button and complete the form to submit a query</p>
      <p>You can also provide feedback on anything else that you would like to see on this platform which may help you in your supplier journey</p>
      <section class="queries">
        <h2>My queries</h2>
        <p class="init">Loading...</p>
        <div class="list hidden"></div>
      </section>
    </main>
    <footer></footer>
    <template id="templateContent">
      <div class="query">
        <h3></h3>
        <details>
          <summary>View more details</summary>
          <p></p>
          <img />
        </details>
        <button type="button" class="danger">Delete</button>
      </div>   
    </template>
    <template id="modal">
      <div class="modal close">
        <form name="query" enctype="multipart/form-data" method="POST" action="https://satcap-research.web.app/api/query">
          <input type="hidden" name="userRef" value="" />
          <input type="hidden" name="mineDocId" value="" />
          <input type="hidden" name="locationDocId" value="" />
          <input type="hidden" name="linkDocId" value="" />
          <h2>Create a new query</h2>
          <label>
            Subject / Title
            <input type="text" name="title" />
          </label>
          <label>
            Describe your query
            <textarea name="description"></textarea>
          </label>
          <label>
            Image (Optional)
            <input type="file" name="image" accept="image/*"/>
          </label>
          <label>
            Name
            <input type="text" name="name" />
          </label>
          <label>
            Contact information (Email or mobile)
            <input type="text" name="contact" />
          </label>
          <details>
            <summary>Click here to see what you're consenting to</summary>
            <ul>
              <li>I voluntarily agree to participate in this pilot study for a community needs assessment digital application.</li>
              <li>I understand that I am participating in an assessment of this digital application in this pilot test of my own free will.</li>
              <li>I understand that I should not expect any financial gain, remuneration or benefit directly for participation in this pilot test.</li>
              <li>I understand that all information I provide in this study will be treated confidentially and no personal information will be shared.</li>
              <li>I understand that my participation in this pilot will in no way advantage or disadvantage me in future engagements with the host organisation.</li>
              <li>I understand that as the information will be stored anonymously, I may not be able to access my specific queries.</li>
              <li>I understand that participating in this pilot does not mean that I will expect any action to be taken from the host organisation based on my responses and feedback.</li>
            </ul>
          </details>
          <form>
            <label><input type="checkbox" name="giveConsent" required/>I understand and consent to the above</label>
          <button type="submit">Submit query</button>
          <button type="button" class="close secondary">Cancel</button>
        </form>
      </div>
    </template>
    <script defer src="https://unpkg.com/dayjs@1.11.5/dayjs.min.js"></script>
    <script type="module">
      import { submit } from './_scripts/queries.js?v=1'

      const enableSubmitBtn = function () {
        const form = document.forms.query
        if (form) {
          form.addEventListener('submit', submit)
        }
      }
      const setHiddenValues = function () {
        const localLink = JSON.parse(window.localStorage.getItem('link'))
        if (!localLink) {
          setTimeout(setHiddenValues, 500)
          return
        }
        document.querySelector('[name="userRef"]').value = window.localStorage.getItem('userRef')
        document.querySelector('[name="mineDocId"]').value = localLink.mineDocId
        document.querySelector('[name="locationDocId"]').value = localLink.locationDocId
        document.querySelector('[name="linkDocId"]').value = localLink.docId
      }

      const btn = document.querySelector('#newQuery')
      if (btn) {
        btn.addEventListener('click', (e) => {
          const template = document.getElementById('modal')
          const content = template.content.cloneNode(true)
          const form = content.querySelector('form')
          const closers = content.querySelectorAll('.close')

          form.addEventListener('click', (e) => {
            e.stopPropagation()
          })
          closers.forEach((close) => {
            close.addEventListener('click', (e) => {
              e.stopPropagation()
              document.querySelector('.modal').remove()
            })
          })
          document.body.appendChild(content)
          setHiddenValues()
          enableSubmitBtn()
        })
      }
    </script>
    <script defer type="module">
      import { app, db, getLink, initMenu } from './_scripts/init.js'
      import { getAllQueries, insertQueryContent } from './_scripts/content.js'

      const link = await getLink()
      if (!link) {
        location.href = '/error?code=link'
      }

      if (!link.package.scopes?.length) location.href = '/error?code=link.scopes'

      if (!link.package.scopes.includes('queries')) location.href = '/?linkId='+link.linkId

      if (link.package.scopes.length === 1 && link.package.scopes[0] === 'survey') {
        if (!link.package.survey?.key) location.href = '/error?code=link.survey.key'
        location.href = `survey/${link.package.survey.key}?linkId=${link.linkId}`
      }

      initMenu(link.linkId, link.package.scopes)

      const queries = await getAllQueries(link.mineDocId)
      const loader = document.querySelector('.init')
      if (loader) {
        loader.remove()
      }
      insertQueryContent('queries', queries)
    </script>
  </body>
</html>