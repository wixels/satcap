<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" media="screen" href="./_style/app.screen.css">
    <link rel="stylesheet" media="screen" href="./_style/queries.screen.css">
    <title>Discussion Board</title>
  </head>
  <body>
    <header>
      <h1>Discussion Board</h1>
    </header>
    <main>
      <button type="button" class="primary" id="newQuery">Create new</button>
      <section class="queries">
        <h2>Existing queries</h2>
        <p class="init">Loading...</p>
        <div class="list hidden"></div>
      </section>
    </main>
    <footer></footer>
    <template id="templateContent">
      <div class="query">
        <h3></h3>
        <details>
          <summary>View more details</summary>
          <p></p>
          <img />
        </details>
        <button type="button" class="danger">Delete</button>
      </div>   
    </template>
    <template id="modal">
      <div class="modal close">
        <form name="query" enctype="multipart/form-data" method="POST" action="https://satcap-research.web.app/api/query">
          <input type="hidden" name="userRef" value="" />
          <input type="hidden" name="mineDocId" value="" />
          <input type="hidden" name="locationDocId" value="" />
          <input type="hidden" name="linkDocId" value="" />
          <h2>Create a new query</h2>
          <label>
            Subject / Title
            <input type="text" name="title" />
          </label>
          <label>
            Describe your query
            <textarea name="description"></textarea>
          </label>
          <label>
            Image (Optional)
            <input type="file" name="image" accept="image/*"/>
          </label>
          <label>
            <input type="checkbox" name="isAnonymous" checked />
            Remain anonymous
          </label>
          <div id="notAnon"></div>
          <button type="submit">Submit query</button>
          <button type="button" class="close secondary">Cancel</button>
        </form>
      </div>
    </template>
    <template id="notAnonymous">
      <label class="notAnonymous">
        Name
        <input type="text" name="name" />
      </label>
      <label class="notAnonymous">
        Contact information (Email or mobile)
        <input type="text" name="contact" />
      </label>
    </template>
    <script defer src="https://unpkg.com/dayjs@1.11.5/dayjs.min.js"></script>
    <script type="module">
      import { submit } from './_scripts/queries.js'

      const enableAnonCheckbox = function () {
        const anonymousCheckbox = document.querySelector('input[type="checkbox"][name="isAnonymous"]')
        if (anonymousCheckbox) {
          anonymousCheckbox.addEventListener('input', (e) => {
            if (!e.currentTarget.checked) {
              const template = document.getElementById('notAnonymous')
              const content = template.content.cloneNode(true)
              document.getElementById('notAnon').appendChild(content)
            } else {
              const existingEls = document.querySelectorAll('.notAnonymous')
              if (existingEls.length) {
                for (const el of existingEls) {
                  el.remove()
                }
              }
            }
          })
        }
      }
      const enableSubmitBtn = function () {
        const form = document.forms.query
        if (form) {
          form.addEventListener('submit', submit)
        }
      }
      const setHiddenValues = function () {
        const localLink = JSON.parse(window.localStorage.getItem('link'))
        if (!localLink) {
          setTimeout(setHiddenValues, 500)
          return
        }
        document.querySelector('[name="userRef"]').value = window.localStorage.getItem('userRef')
        document.querySelector('[name="mineDocId"]').value = localLink.mineDocId
        document.querySelector('[name="locationDocId"]').value = localLink.locationDocId
        document.querySelector('[name="linkDocId"]').value = localLink.docId
      }

      const btn = document.querySelector('#newQuery')
      if (btn) {
        btn.addEventListener('click', (e) => {
          const template = document.getElementById('modal')
          const content = template.content.cloneNode(true)
          const form = content.querySelector('form')
          const closers = content.querySelectorAll('.close')

          form.addEventListener('click', (e) => {
            e.stopPropagation()
          })
          closers.forEach((close) => {
            close.addEventListener('click', (e) => {
              e.stopPropagation()
              document.querySelector('.modal').remove()
            })
          })
          document.body.appendChild(content)
          setHiddenValues()
          enableAnonCheckbox()
          enableSubmitBtn()
        })
      }
    </script>
    <script defer type="module">
      import { app, db, link, initMenu } from './_scripts/init.js'
      import { getAllQueries, insertQueryContent } from './_scripts/content.js'

      if (!link) {
        location.href = '/error?code=link'
      }

      if (!link.package.scopes?.length) location.href = '/error?code=link.scopes'

      if (!link.package.scopes.includes('queries')) location.href = '/?linkId='+link.linkId

      if (link.package.scopes.length === 1 && link.package.scopes[0] === 'survey') {
        if (!link.package.survey?.key) location.href = '/error?code=link.survey.key'
        location.href = `survey/${link.package.survey.key}?linkId=${link.linkId}`
      }

      initMenu(link.linkId, link.package.scopes)

      const queries = await getAllQueries(link.mineDocId)
      const loader = document.querySelector('.init')
      if (loader) {
        loader.remove()
      } 
      console.log('Queries: ', queries)
      insertQueryContent('queries', queries)
    </script>
  </body>
</html>